# name: CI Pipeline

# on:
#   push:
#     branches:
#       - "**"
#   pull_request:
#     branches:
#       - "**"
#   workflow_dispatch:
#   schedule:
#     - cron: "50 17 * * *"   # 11:20 PM IST daily

# permissions:
#   contents: write   # âœ… allow pushing index.html back to repo

# env:
#   JAVA_DISTRIBUTION: temurin
#   JAVA_VERSION: 24
#   WORKDIR: eclipse-workspace/Intro
#   ARTIFACT_RETENTION_DAYS: 7

# jobs:
#   test:
#     runs-on: windows-latest
#     timeout-minutes: 300
#     env:
#       REPORT_BASE: "/amazon-filter-e2e-automation/"
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#           persist-credentials: true   # âœ… ensures GITHUB_TOKEN is kept for pushing

#       - name: Set up JDK
#         uses: actions/setup-java@v4
#         with:
#           distribution: ${{ env.JAVA_DISTRIBUTION }}
#           java-version: ${{ env.JAVA_VERSION }}
#           cache: maven

#       - name: Cache Maven target and .m2 repo (optional)
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.m2/repository
#             ${{ env.WORKDIR }}/target
#           key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
#           restore-keys: |
#             maven-${{ runner.os }}-

#       - name: Print environment info
#         shell: bash
#         run: |
#           echo "Java version:"
#           java -version
#           echo "Maven version:"
#           mvn -v
#           echo "Working directory: ${{ env.WORKDIR }}"
#           echo "Runner OS: $RUNNER_OS"

#       - name: Notify Discord â€“ Start of Test
#         if: always()
#         shell: bash
#         env:
#           DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
#         run: |
#           runUrl="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
#           timestamp=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M %p IST")
#           actor="${{ github.actor }}"
#           branch="${{ github.ref_name }}"
#           job_name="${{ github.job }}"

#           curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"ðŸš€ **CI Test Started - $job_name**\\nðŸ‘¤ Triggered by: $actor\\nðŸŒ¿ Branch: $branch\\nðŸ•’ Start Time: $timestamp\\nðŸ”— [View Run]($runUrl)\"}" "$DISCORD_WEBHOOK"


#       - name: Set RUN_TIMESTAMP (Windows runner)
#         id: set_ts
#         shell: pwsh
#         run: |
#           # produce format yyyy-MM-dd_HH-mm-ss (matches local format)
#           $ts = Get-Date -Format 'yyyy-MM-dd_HH-mm-ss'
#           Write-Host "RUN_TIMESTAMP = $ts"
#           # export to GITHUB_ENV for subsequent steps
#           Add-Content -Path $env:GITHUB_ENV -Value "RUN_TIMESTAMP=$ts"

#       - name: Run Maven Tests
#         working-directory: ${{ env.WORKDIR }}
#         shell: bash
#         run: |
#             ABS_LOGS_DIR="${GITHUB_WORKSPACE}/${{ env.WORKDIR }}/logs/run_${{ env.RUN_TIMESTAMP }}"
#             echo "Setting logs.dir = $ABS_LOGS_DIR"
#             mvn -B -ntp clean test -DrunTimestamp="${{ env.RUN_TIMESTAMP }}" -Dlogs.dir="$ABS_LOGS_DIR"


      


#       # - name: Copy ExtentReport and publish to GitHub Pages
#       #   if: always()
#       #   shell: bash
#       #   working-directory: ${{ env.WORKDIR }}
#       #   run: |
#       #     set -euo pipefail

#       #     REPORT_SRC="test-output/ExtentReports/ExtentReport.html"
#       #     REPO_ROOT="$GITHUB_WORKSPACE"

#       #     if [ ! -f "$REPORT_SRC" ]; then
#       #       echo "No ExtentReport found at $REPORT_SRC"
#       #       exit 0
#       #     fi

#       #     echo "Copying report from $REPORT_SRC to $REPO_ROOT/index.html"
#       #     cp "$REPORT_SRC" "$REPO_ROOT/index.html"

#       #     cd "$REPO_ROOT"

#       #     git config user.name "github-actions"
#       #     git config user.email "actions@github.com"

#       #     git add index.html
#       #     git commit -m "Publish ExtentReport [skip ci]" || echo "No changes to commit"
#       #     git push origin HEAD


#       - name: Copy ExtentReport and publish to gh-pages (fixed)
#         if: ${{ always() && github.ref != 'refs/heads/gh-pages' }}
#         shell: bash
#         run: |
#           set -euo pipefail

#           # absolute path to the generated report
#           REPORT_SRC="${GITHUB_WORKSPACE}/${{ env.WORKDIR }}/test-output/ExtentReports/ExtentReport.html"
#           if [ ! -f "$REPORT_SRC" ]; then
#             echo "No ExtentReport found at $REPORT_SRC â€” skipping publish"
#             exit 0
#           fi

#           echo "Preparing report..."
#           TMPDIR="$(mktemp -d)"
#           cp "$REPORT_SRC" "$TMPDIR/index.html"

#           # ensure git identity
#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"

#           # work from the repo root so git commands and cp target align
#           cd "$GITHUB_WORKSPACE"

#           # stash any local changes so checkout won't be blocked
#           git stash push -u -m "ci: temporary stash before gh-pages checkout" >/dev/null 2>&1 || true

#           # fetch and check whether gh-pages exists remotely
#           git fetch origin gh-pages || true
#           if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
#             git checkout gh-pages
#           else
#             # create orphan gh-pages branch if it does not exist
#             git checkout --orphan gh-pages
#             git rm -rf . >/dev/null 2>&1 || true
#             git commit --allow-empty -m "init gh-pages branch [skip ci]" || true
#             git push origin HEAD:gh-pages
#           fi

#           # copy prepared index into the branch root (we are at repo root)
#           cp "$TMPDIR/index.html" index.html

#           # commit only index.html and push
#           git add index.html
#           if git diff --staged --quiet; then
#             echo "No changes to index.html on gh-pages"
#           else
#             git commit -m "ci: publish ExtentReport [skip ci]"
#             git push origin gh-pages
#           fi

#           # return to previous branch
#           git checkout - >/dev/null 2>&1 || true

#           # restore stash (if any)
#           if git rev-parse --verify --quiet refs/stash >/dev/null 2>&1; then
#             git stash pop >/dev/null 2>&1 || true
#           fi

#           rm -rf "$TMPDIR"
#           echo "Publish step complete."



#       - name: Package Extent Report bundle with screenshots and logs
#         if: always()
#         shell: bash
#         working-directory: ${{ env.WORKDIR }}
#         run: |
#           mkdir -p artifacts/extent
#           if [ -d "test-output/ExtentReports" ]; then
#             cp -r test-output/ExtentReports artifacts/extent/ExtentReports
#           fi
#           if [ -d "test-output/screenshots" ]; then
#             cp -r test-output/screenshots artifacts/extent/screenshots
#           fi
#           if [ -d "logs" ]; then
#             cp -r logs artifacts/extent/logs
#           fi
#           echo "<html><body><h3>Artifacts</h3><ul><li><a href='ExtentReports/ExtentReport.html'>Open Extent Report</a></li></ul></body></html>" > artifacts/extent/index.html


    


#       - name: Upload Extent Report Bundle (HTML + screenshots + logs)
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: extent-report-bundle
#           path: ${{ env.WORKDIR }}/artifacts/extent
#           retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
#           if-no-files-found: warn


#       - name: Deploy to gh-pages (safe)
#         if: ${{ always() && github.ref != 'refs/heads/gh-pages' }}
#         shell: bash
#         run: |
#           # sanity: ensure folder exists before running deploy action
#           PUBLISH_DIR="${GITHUB_WORKSPACE}/${{ env.WORKDIR }}/artifacts/extent"
#           if [ ! -d "$PUBLISH_DIR" ]; then
#             echo "Publish dir not found: $PUBLISH_DIR â€” skipping deploy"
#             exit 0
#           fi
#         # The next step is the deploy action which will actually push the folder
#       - name: Deploy to gh-pages (action)
#         if: ${{ always() && github.ref != 'refs/heads/gh-pages' }}
#         uses: peaceiris/actions-gh-pages@v4
#         with:
#           github_token: ${{ secrets.GITHUB_TOKEN }}
#           publish_dir: ${{ github.workspace }}/${{ env.WORKDIR }}/artifacts/extent
#           publish_branch: gh-pages
#           keep_files: false
#           user_name: "github-actions[bot]"
#           user_email: "github-actions[bot]@users.noreply.github.com"
#           commit_message: "ci: publish extent report (${{ env.RUN_TIMESTAMP }}) [skip ci]"

      
 
#       - name: Upload Raw Logs (optional)
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: framework-logs
#           path: |
#             ${{ env.WORKDIR }}/logs
#           retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
#           if-no-files-found: ignore

#       - name: Notify Discord â€“ End of Test
#         if: always()
#         shell: bash
#         env:
#           DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
#         run: |
#           runUrl="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
#           artifactUrl="${runUrl}#artifacts"
#           status="${{ job.status }}"

#           if [ "$status" = "success" ]; then
#             status_emoji="âœ…"
#           elif [ "$status" = "failure" ]; then
#             status_emoji="âŒ"
#           else
#             status_emoji="âš ï¸"
#           fi

#           commit_sha="${{ github.sha }}"
#           commit_short="${commit_sha:0:7}"
#           branch="${{ github.ref_name }}"
#           actor="${{ github.actor }}"
#           timestamp=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M %p IST")

#           pagesUrl="https://sagarjhathi.github.io/amazon-filter-e2e-automation/"

#           curl -H "Content-Type: application/json" \
#                -X POST \
#                -d "{\"content\": \"$status_emoji **CI Pipeline - ${{ github.job }}** ($branch): $status\\nðŸ‘¤ Triggered by: $actor\\nðŸ”– Commit: \`$commit_short\`\\nðŸ•’ Completed at: $timestamp\\nðŸ”— [View Full Run Details]($runUrl)\\nðŸ“¦ [Download Extent Report & Artifacts]($artifactUrl)\\nðŸŒ [Open Latest Report on GitHub Pages]($pagesUrl)\"}" \
#                "$DISCORD_WEBHOOK"


 name: CI Pipeline

 on: 
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:
  schedule:
    - cron: "50 17 * * *"   # 11:20 PM IST daily

 permissions:
  contents: write

 env:
  JAVA_DISTRIBUTION: temurin
  JAVA_VERSION: 24
  WORKDIR: eclipse-workspace/Intro
  ARTIFACT_RETENTION_DAYS: 7

 jobs:
  test:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Cache Maven target and .m2 repo (optional)
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ${{ env.WORKDIR }}/target
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Print environment info
        shell: bash
        run: |
          echo "Java version:"
          java -version
          echo "Maven version:"
          mvn -v
          echo "Working directory: ${{ env.WORKDIR }}"
          echo "Runner OS: $RUNNER_OS"

      - name: Notify Discord â€“ Start of Test
        if: always()
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          runUrl="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          timestamp=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M %p IST")
          actor="${{ github.actor }}"
          branch="${{ github.ref_name }}"
          job_name="${{ github.job }}"
          curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"CI Test Started - $job_name\nTriggered by: $actor\nBranch: $branch\nStart Time: $timestamp\nView Run: $runUrl\"}" "$DISCORD_WEBHOOK"

      - name: Set RUN_TIMESTAMP (Windows runner)
        id: set_ts
        shell: pwsh
        run: |
          $ts = Get-Date -Format 'yyyy-MM-dd_HH-mm-ss'
          Write-Host "RUN_TIMESTAMP = $ts"
          Add-Content -Path $env:GITHUB_ENV -Value "RUN_TIMESTAMP=$ts"

      - name: Compute REPORT_BASE for this run
        shell: bash
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          echo "REPORT_BASE=/${REPO_NAME}/runs/${RUN_TIMESTAMP}/" >> "$GITHUB_ENV"

      - name: Run Maven Tests
        working-directory: ${{ env.WORKDIR }}
        shell: bash
        run: |
          ABS_LOGS_DIR="${GITHUB_WORKSPACE}/${{ env.WORKDIR }}/logs/run_${{ env.RUN_TIMESTAMP }}"
          echo "Setting logs.dir = $ABS_LOGS_DIR"
          mvn -B -ntp clean test -DrunTimestamp="${{ env.RUN_TIMESTAMP }}" -Dlogs.dir="$ABS_LOGS_DIR"

      - name: Package Extent Report bundle with screenshots and logs
        if: always()
        shell: bash
        working-directory: ${{ env.WORKDIR }}
        run: |
          mkdir -p artifacts/extent
          if [ -d "test-output/ExtentReports" ]; then
            cp -r test-output/ExtentReports artifacts/extent/ExtentReports
          fi
          if [ -d "test-output/screenshots" ]; then
            cp -r test-output/screenshots artifacts/extent/screenshots
          fi
          if [ -d "logs" ]; then
            cp -r logs artifacts/extent/logs
          fi
          cat > artifacts/extent/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <title>Test Artifacts</title>
          <p><a href="ExtentReports/ExtentReport.html">Open Extent Report</a></p>
          HTML

      - name: Upload Extent Report Bundle (HTML + screenshots + logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extent-report-bundle
          path: ${{ env.WORKDIR }}/artifacts/extent
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: warn

      # === DEPLOY HISTORY MODEL ===

      - name: Deploy this run to gh-pages/runs/<timestamp>
        if: ${{ always() && github.ref != 'refs/heads/gh-pages' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ github.workspace }}/${{ env.WORKDIR }}/artifacts/extent
          publish_branch: gh-pages
          destination_dir: runs/${{ env.RUN_TIMESTAMP }}
          keep_files: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "ci: publish run ${{ env.RUN_TIMESTAMP }} (preserve history)"

      - name: Generate and publish root index and history
        if: ${{ always() && github.ref != 'refs/heads/gh-pages' }}
        shell: bash
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY}"
          REPO_NAME="${REPO#*/}"
          OWNER="${REPO%/*}"
          RUN_TS="${RUN_TIMESTAMP}"

          WORK_GHP="$(mktemp -d)"
          PUBLISH_ROOT="$(mktemp -d)"

          git -C "$WORK_GHP" init >/dev/null
          git -C "$WORK_GHP" remote add origin "https://github.com/${REPO}.git"
          git -C "$WORK_GHP" fetch origin gh-pages || true

          if git -C "$WORK_GHP" show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git -C "$WORK_GHP" checkout -q gh-pages
          else
            git -C "$WORK_GHP" checkout -q --orphan gh-pages
            mkdir -p "$WORK_GHP"
          fi

          LATEST_URL="https://${OWNER}.github.io/${REPO_NAME}/runs/${RUN_TS}/ExtentReports/ExtentReport.html"
          mkdir -p "$PUBLISH_ROOT"

          cat > "$PUBLISH_ROOT/index.html" <<EOF
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=${LATEST_URL}">
          <title>Opening Latest Report</title>
          <p><a href="${LATEST_URL}">Open latest report</a></p>
          <p>Or see <a href="./history.html">Run History</a>.</p>
          EOF

          {
            echo "<!doctype html><meta charset='utf-8'><title>Automation Report History</title>"
            echo "<h1>Automation Report History</h1>"
            echo "<p>Latest: <a href='${LATEST_URL}'>${RUN_TS}</a></p>"
            echo "<h2>Runs</h2><ul>"
            if [ -d "$WORK_GHP/runs" ]; then
              ls -1 "$WORK_GHP/runs" | sort -r | while read -r d; do
                echo "<li><a href='/${REPO_NAME}/runs/${d}/ExtentReports/ExtentReport.html'>${d}</a></li>"
              done
            fi
            if [ ! -d "$WORK_GHP/runs/${RUN_TS}" ]; then
              echo "<li><a href='/${REPO_NAME}/runs/${RUN_TS}/ExtentReports/ExtentReport.html'>${RUN_TS}</a></li>"
            fi
            echo "</ul>"
          } > "$PUBLISH_ROOT/history.html"

          echo "PUBLISH_ROOT=$PUBLISH_ROOT" >> $GITHUB_ENV

      - name: Publish root pages (index.html + history.html)
        if: ${{ always() && github.ref != 'refs/heads/gh-pages' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.PUBLISH_ROOT }}
          publish_branch: gh-pages
          keep_files: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "ci: update root index and history (latest -> ${{ env.RUN_TIMESTAMP }})"

      - name: Upload Raw Logs (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: framework-logs
          path: |
            ${{ env.WORKDIR }}/logs
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: ignore

      - name: Notify Discord â€“ End of Test
        if: always()
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          runUrl="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          artifactUrl="${runUrl}#artifacts"
          status="${{ job.status }}"
          if [ "$status" = "success" ]; then status_emoji="SUCCESS"; elif [ "$status" = "failure" ]; then status_emoji="FAILURE"; else status_emoji="NEUTRAL"; fi
          commit_sha="${{ github.sha }}"
          commit_short="${commit_sha:0:7}"
          branch="${{ github.ref_name }}"
          actor="${{ github.actor }}"
          timestamp=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M %p IST")
          pagesUrl="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"CI Pipeline - ${{ github.job }} ($branch): $status\nTriggered by: $actor\nCommit: \`$commit_short\`\nCompleted: $timestamp\nRun: $runUrl\nArtifacts: $artifactUrl\nPages: $pagesUrl\"}" \
               "$DISCORD_WEBHOOK"
  

         
      

    