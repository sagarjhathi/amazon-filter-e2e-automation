name: CI Pipeline at POM branch

on:
  push:
    branches:
      - '**'   # Runs on all branches
  workflow_dispatch:
  schedule:
  - cron: '35 18 * * *'  # 12:05 AM IST

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 24

      - name: Notify Test Start on Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                     \"content\": \"ðŸš€ **CI Test Run Started**\nðŸ•’ **Start Time:** $timestamp\nðŸ“¦ **Repo:** $GITHUB_REPOSITORY\nðŸ”— [Run Link]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)\"
                   }" \
               $DISCORD_WEBHOOK

      - name: Run Maven Tests
        working-directory: eclipse-workspace/Intro
        run: mvn clean test
        continue-on-error: true

      - name: Upload Surefire Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: eclipse-workspace/Intro/target/surefire-reports

      - name: Upload Extent Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extent-reports
          path: eclipse-workspace/Intro/test-output/ExtentReports/

      - name: Notify on Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          status="${{ job.status }}"
          timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                     \"content\": \"ðŸ“¢ **CI Test Run Status:** $status\nðŸ•’ **End Time:** $timestamp\nðŸ“„ **Extent Report** is available in the [Artifacts section]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)\nðŸ”— [Click to View Run]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)\"
                   }" \
               $DISCORD_WEBHOOK
